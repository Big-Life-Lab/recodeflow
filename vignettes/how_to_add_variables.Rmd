---
title: "How to add datasets and variables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to add variables to cchsflow}     
  %\VignetteEngine{knitr::rmarkdown} 
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")

source("../R/test_data_generator.R")
```


# How to use `recodeflow` with your data

To use `recodeflow` with your data, you'll need create the worksheets:

- `variable_details` mapping of variables across datasets and a list of instructions on how to transform variable(s), and
- `variable_sheet` a list of variables to transform, and

Files can either be a `.csv` file that you import to R or create directly in R (as a dataframe).

Our examples use the dataset `pbc` from the package [survival](https://cran.r-project.org/web/packages/survival/index.html). We've split this dataset into two (tester1 and tester2) to mimic real data e.g., the same survey preformed in separate years. We've also added columns (`agegrp5` and `agegrp10`) to this dataset for our examples.

For the following examples, we'll use our example datasets and the variable `status`.
The variable `status` captures the status of the patient at the end of the study: censored, received a transplant, or dead.



## How to create the `var_details` worksheet

The `variable_details` worksheet does two important steps. First, it maps variables across datasets. Second, it gives instructions on how to transform the variables. 

Note: additional information for the `var_details` worksheet is in the article [variable_details](../reference/variable_details.html).

Note: additional details on how to add derived variables to the `var_detials` worksheet is in the article [derived_variables](../reference/derived_variables.html).

### Rows

For the `status` variable, there are the following six rows:

- 3 categorical responses (censored, transplant, dead), 
- 1 for missing, 
- 1 for not applicable, and 
- 1 for else. 

Since `status` is coded consistently across the two datasets no additional rows are required. 


### Columns (16)

1. **variable:** the name of the final transformed variable. We'll use the same name as in the original dataset `status` though you could rename the variable.

Write `status` in the column **variable** in the six rows.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
kable(var_details[1:6, 1], col.names = 'variable')
```

2. **dummyVariable:** Since `status` is a categorical variable it has dummy variables. 

Write the final variable name, the number of categories within the variable, and the category level for each category, in the six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:2])
```

3. **toType:** `status` is originally a categorical vaiable and captures different outcomes for patients. Therefore, it does not make sense to change `status` into a continuous variable. 

Write 'cat' in the six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:3])
```

4. **databaseStart:** `status` was captured identically for both datasets. Therefore, we'll transform the variable the same way regardless of which dataset it's from.

Write the dataset names, separated by a comma, in the six rows

```{r, echo=FALSE, warning=FALSE}
kable(var_details[c(1, 6), 1:4])
```

5. **variableStart:** the name of the transformed variables `status` is identical to the original variable `status`. Also, the original variable `status` is identical across our datasets. 

Write the variable name in squared brackets once, per row, for all six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[c(1, 6), 1:5])
```

6. **fromType:** `status` is originally a categorical variable.

Write 'cat' in the six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:4])
```

7. **variableStartShortLabel:** 

Write "status" in the 6 rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:7])
```

8. **variableStartLabel:** Include the definition of the variable, as stated in the original data documentation. 

Write "status at end of study" in the six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:8])
```

9. **recTo:** Since `status` is a categorical variable, you'll capture the category you are transforming each row too. For the not applicable rows `NA::a` is written. For the missing and else rows `NA::b` is written. The `haven` package is used for tagging NA in numeric variables.

Write the category level you are transforming each row too. For the not applicable rows `NA::a` is written. For the missing and else rows `NA::b` is written.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:9])
```

10. **numValidCat:** The number of categories within the variable `status`. There are three categories in `status`: 0-censored, 1-transplant, and 2-dead. Note that for categories: not applicable, missing, and else, are not included in the category count.

Write 3 in each of the six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:10])
```

11. **catLabel:** Name the categorical level for the transformed variable.

Write: "censored" in the first row, "transplant" in the second row, "dead" in the third row, "not applicable" in the forth row, "missing" in the fifth row, and "else" in the sixth row. 

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:11])
```

12. **catLabelLong:** You can elaborate on the name of the categorical level of the transformed variable. For our example we will not. 

Copy input in **catLabel** to **catLabelLong** for each row.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:12])
```

13. **units:** The status of the patient at the end of the study does not have measurement units. 

Write "N/A" in all six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:13])
```

14. **recFrom:** Since we are not combining levels of categories and we are keeping the category levels the same, the recFrom column will be identical to recTo. 

Write the category level you are transforming each row too. For the not applicable rows `NA::a` is written. For the missing and else rows `NA::b` is written.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:14])
```

15. **catStartLabel:** The `status` label should be identical to what is shown in the original data documentation. For the missing rows, each missing category is described along with their coded values.

Write: "censored" in the first row, "transplant" in the second row, "dead" in the third row, "not applicable" in the forth row, "missing" in the fifth row, and "else" in the sixth row.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:15])
```

16. **notes: ** Capture any important differences in a variable across datasets. For our example, there are no differences across datasets.

Write "This is sample survival pbc data" in all six rows.

```{r, echo=FALSE, warning=FALSE}
kable(var_details[1:6, 1:16])
```



## How to create the variables worksheet `var_sheet`

Once mapped and specified on `variable_details`, the `status` variable can be specified on the variables worksheet: `var_sheet`. Ensure that the names you used in the `var_details` worksheet are identical to those listed in `var_sheet`.

1. **variable:** the name of the transformed variable (var_detail worksheet column 'variable')

2. **label:** the shorthand label for the variable (var_detail worksheet column 'variableShortLabel')

3. **labelLong:** a more detailed label for the variable (var_detail worksheet column 'variableStartLabel')

4. **section:** the section where this variable could be found (new column, it is not in the var_details worksheet)

5. **subject:** what the variable pertains to  (new column, it is not in the var_details worksheet)

6. **variableType:** whether the transformed variable is categorical or continuous (var_detail worksheet column 'toType')

7. **units:** any units for the variable (var_detail worksheet column 'units')

8. **databaseStart:** the list of databases that contain the variable of interest (var_detail worksheet column 'databaseStart')

9. **variableStart** the original variable name (var_detail worksheet column 'variableStart')

```{r, echo=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
kable(var_sheet[2, ])
```
