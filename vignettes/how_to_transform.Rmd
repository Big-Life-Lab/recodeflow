---
title: "How to transform variables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to guides}     
  %\VignetteEngine{knitr::rmarkdown}  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = "#>")
source("../R/test_data_generator.R")
```

# How to transfrom variables

We have examples to demonstrate how to transform variables with the _recodeflow_ function [`rec_with_table()`](../reference/rec_wtih_table.html)

Our examples use following packages.

Package _recodeflow_ Steps on how to install `recodeflow` are in [how to install](../reference/how_to_install.html)
```{r results= 'hide', message = FALSE, warning=FALSE}
#Load the package
library(recodeflow)
```

Package [dplyr](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8) to combine datasets (function: `bind_rows`).

```{r results = 'hide', message = FALSE, warning =FALSE}
library(dplyr)
```

Our examples use the dataset `pbc` from the package [survival](https://cran.r-project.org/web/packages/survival/index.html). We've split this dataset into two (tester1 and tester2) to mimic real data e.g., the same survey preformed in separate years. We've also added columns (`agegrp5` and `agegrp10`) to this dataset for our examples.


## Example 1. How to transform a single variable from a single dataset

We'll transform the variable `status` in dataset tester1 into a harmonized `status` variable.

```{r}
#Transform the variable Status in dataset tester1
status <- rec_with_table(data = tester1, 
                         variables = "status", 
                         variable_details = var_details,
                         log = TRUE
                         )
```

```{r, echo=FALSE}
head(status)
```


## Example 2. How to transform a single variable across multiple datasets

We'll transform and combine a single variable across multiple
datasets (e.g., combining surveys from different years). 

The sex variable in tester1 (`sex_a`) and tester2
(`sex_b`) is transformed into common variable (`sex`) and combined into a
single dataset. See the [variable_details article](variable_details.html) for instructions on how `sex` is transformed.

1) Transform the sex variable in tester1 and tester2.
```{r, warning = FALSE}
#Transform the variable sex in from dataset tester1
sex_1 <- rec_with_table(data = tester1, 
                        variables = "sex_a", 
                        variable_details = var_details, 
                        log = TRUE,
                        )

head(sex_1)

#Transform the variable sex in from dataset tester2
sex_2 <- rec_with_table(data = tester2, 
                        variables = "sex_a", 
                        variable_details = var_details, 
                        log = TRUE
                        )
tail(sex_2)
```

2) Combine the harmonized sex variable from tester1 to the harmonized sex variable in tester2.
```{r, warning=FALSE}
combined_sex <- bind_rows(sex_1, sex_2)
```

```{r, echo=FALSE}
head(combined_sex)
tail(combined_sex)
```

-_____________________________________________-
(Still need to update)
## Example 3. How to transform a single variable, with different categories, from multiple datasets {#example3}

You could have a situation a variable is the same across datasets but its categories change. 

In our example data the variable `agegrp` is different in tester1 and tester2. 

- In tester1 the `agegrp` variable is 5-year age groups of 5 years: 20-24, 25-29, 30-34, 35-40, etc.
- In tester2 the `agegrp` variable is 10-year age groups of 10 years: 20-29, 30-39, 40-49, etc.

There are three options to facilitate the use of variables with inconsistent categories across cycles. 


### Option 1: transform category `age` variable into a common variable for only cycles with the same category responses

Transform the `agegrp` variable into a common variable only in datasets were the categories are the same. If the categories are different between data cycles, separate columns will be created. 

The categories in the `agegrp` variable in tester1 are different than the categories of `agegrp` in tester2. Therefore, it is not possible to have the same `agegrp` categories across our example data sets.

-______________________-
Its transforming both agegrp5 and agegrp_cont variables.....

```{r, warning=FALSE}
agetester1 <- rec_with_table(data = tester1, 
                             variables = "agegrp5", 
                             variable_details = var_details, 
                             log = TRUE)
head(agetester1)


agetester2 <- rec_with_table(data = tester2, 
                             variables = "agegrp10", 
                             variable_details = var_details, 
                             log = TRUE)
head(agetester2)

```

```{r, warning=FALSE}
combined_age_cat <- bind_rows(agetester1, agetester2)
```

```{r, echo=FALSE}
head(combined_age_cat)
tail(combined_age_cat)
```


### Option 2: transform the categorical `agegrp` variable into a continuous `age_cont` variable

Transform categorical variables such as `agegrp` into a single harmonized
`age_cont` variable. This variable takes the midpoint age of each category for 'agegrp' across datasets. With this option, the categorical variable 'agegrp' from each dataset can be combined into a single dataset.

```{r, warning=FALSE}
agetester1_cont <- rec_with_table(data = tester1, 
                             variables = "age_cont", 
                             variable_details = var_details, 
                             log = TRUE)
head(agetester1_cont)


agetester2_cont <- rec_with_table(data = tester2, 
                             variables = "age_cont", 
                             variable_details = var_details, 
                             log = TRUE)
head(agetester2_cont)

```

```{r, warning= FALSE}
combined_age_cont <- bind_rows(agetester1_cont, agetester2_cont)
```

```{r, echo=FALSE}
head(combined_age_cont)
tail(combined_age_cont)
```

### Option 3: transform the categorical `agegrp` variable into a harmonized categorical variable

_recodeflow_ often includes a common harmonized categorical variable that has new,
consistent categories across all cycles. These new categorical variables
generally have fewer category levels than the original variables, reflecting the
need to combine categories. Read the `Notes` variable for details.

### Label variables and categories

Use `set_data_labels()` to label the variables in your final dataset. Labels are
lost during the database merging. `set_data_labels()` set labels with the
original information in `variables` and `variable_details`.

```{r}
labeled_combined <- set_data_labels(
  data_to_label = combined_age_cont,
  variable_details = variable_details,
  variables_sheet = variables
)
```
-_____________________________________________-


## Example 4. How to transform multiple variables from multiple datasets {#example4}

The variables argument in `rec_with_table()` allows multiple variables to be
transformed from a dataset. 

In this example, the age and sex variables from the tester1 and tester2 datasets will be transformed and labeled using `rec_with_table()`. 

We'll then combine the two transformed datasets into a single dataset and labeled
using `set_data_labels()`.

```{r, warning=FALSE}
#Transform variables age adn sex from dataset tester1
age_sex_1 <- rec_with_table(data = tester1, 
                            variables = c("age", "sex"), 
                            variable_details = var_details,
                            log = TRUE, 
                            var_labels = c(age = "Age", sex = "Sex")
                            )
head(age_sex_1)

#Transform variables age adn sex from dataset tester2
age_sex_2 <- rec_with_table(data = tester2, 
                            variables = c("age", "sex"), 
                            variable_details = var_details,
                            log = TRUE, 
                            var_labels = c(age = "Age", sex = "Sex")
                            )
head(age_sex_2)
```

-_____________________________________________-
(STILL NEED TO UPDATE)
In the above example, `var_labels` is called in `rec_with_table()` to label the
age and sex variables in the tester1 and tester2 datasets. Use `get_label()` to view
the variable labels in your transformed dataset. As mentioned previously,
`var_labels` can be used all the variables in `variables.csv` or a subset of
variables.

```{r, warning=FALSE}
combined_age_sex <- bind_rows(age_sex_1, age_sex_2)
head(combined_age_sex)
labeled_combined_age_sex <- set_data_labels(
  data_to_label = combined_age_sex,
  variable_details = var_details, variables_sheet = var_sheet
)
```

In the above code, `set_data_labels()` is used to label the combined age and sex
dataset. Similar to before, you can check if labels have been added using
`get_label()`.

```{r, warning=FALSE}
get_label(labeled_combined_age_sex)
```

For more information on `get_label()` and other label helper functions, please
refer to the [sjlabelled](https://strengejacke.github.io/sjlabelled/reference/)
package.
-_____________________________________________-


## Example 5. How transform all variables in the variable_details sheet {#example5}

All the variables listed in `var_sheet` and `var_details` cab be transformed with `rec_with_table()`. 

In this example, all variables specified in the two worksheets will be transformed and
combined for the tester1 and tester2 datasets.

```{r, echo=FALSE}
options(htmlwidgets.TOJSON_ARGS = list(na = "string"))
```

```{r, warning=FALSE}
#Transform all variables listed in var_sheet, for dataset tester1
transformed1 <- rec_with_table(data = tester1,
                          variables = var_sheet,
                          variable_details = var_details,
                          log = TRUE,
                          )

#Transform all variables listed in var_sheet, for dataset tester2
transformed2 <- rec_with_table(data = tester2,
                          variables = var_sheet,
                          variable_details = var_details,
                          log = TRUE,
                          )
```

```{r, warning=FALSE}
#Combine transformed datasets 
combined_dataset <- bind_rows(transformed1, transformed2)
```

```{r}
labeled_combined <- set_data_labels(data_to_label = combined_dataset,
                                    variable_details = var_details,
                                    variables_sheet = var_sheet
                                    )
```

## Example 6: How to know where the data is from in combined datasets {#example6}

To know the origin of each row of data, you can use the `rec_with_table` argument 
`attach_data_name`. When the argument `attach_data_name` is set to true it will add a column with the name of the dataset the row is from.

```{r, warning=FALSE}
#Transform variables age and sex for dataset tester1 and add the name of the original dataset
age_sex_1 <- rec_with_table(data = tester1,
                            variables = c("age", "sex"), 
                            variable_details = var_details,
                            var_labels = c(age = "Age", sex = "Sex"),
                            log = TRUE,
                            attach_data_name = TRUE
                            )
#Transform variables age and sex for dataset tester2 and add the name of the original dataset
age_sex_2 <- rec_with_table(data = tester2,
                            variables = c("age", "sex"), 
                            variable_details = var_details,
                            var_labels = c(age = "Age", sex = "Sex"),
                            log = TRUE,
                            attach_data_name = TRUE
                            )
```

```{r, warning=FALSE}
#Combine transformed datasets
combined_age_sex <- bind_rows(age_sex_1, age_sex_2)

head(combined_age_sex)
tail(combined_age_sex)
```


## Example 7. Transform derived variables {#example7}

Derived variables are variables that are not in the original dataset; rather they are created using variables the original dataset.

Derived variables require a customized function. Derived variables also need to be defined on `var_sheet` and `var_details`. Descriptions of derived functions are in article [derived functions](../reference/derived_variables.html)

To transform a derived variable, you must also transform the underlying initial variables. For example, the derived variable 'example_der' is created by the mutliplication of variable `chol` and variable `bili`. 

```{r, warning=FALSE}
#Transform the derived variable 'example_der' in dataset tester1
derived1 <- rec_with_table(data = tester1,
                          variables = c("chol", "bili","example_der"),
                          variable_details = var_details,
                          log = TRUE)

#Transform the derived variable 'example_der' in dataset tester2
derived2 <- rec_with_table(data = tester2,
                          variables = c("chol", "bili","example_der"),
                          variable_details = var_details,
                          log = TRUE)

```

```{r, warning=FALSE}
#combine the transformed datasets
combined_der <- bind_rows(derived1, derived2)
```




